/*************************************/
/* Searchable Select */
/* **********************************/

//america by default

var renderSelectedOption = (option) => {
    var identifier = option.flagClassCode;

    return `
        <span class="is-flex is-flex-direction-row">
      <span class="icon mr-2">
        <i class="fi fi-${identifier}"></i>
      </span>
    <span class="icon is-small">
        <i class="fa-solid fa-chevron-down"></i>
        </span>
        `;
};

var selectedPhoneCode = {
    name: 'United States',
    phoneCode: '1',
    flagClassCode: 'us',
};

$('#dropdown-btn-trigger').html(renderSelectedOption(selectedPhoneCode));

var renderOption = (option) => {
    var identifier = option.phoneCode;

    return `<p class="${identifier} dropdown-item is-size-7 text-align-left">
          <span class="icon mr-2">
            <i class="fi fi-${option.flagClassCode}"></i>
          </span>
          ${option.name} (+${option.phoneCode})
            </p>`;
};

function populateOptions() {
    var dropdownContent = $('#dropdownContent');
    dropdownContent.empty();
    countries_flags_and_codes.forEach((option) => {
        dropdownContent.append(renderOption(option));
    });
}

// Initialize with all options
populateOptions();

$('#searchInput').on('input', function () {
    var searchTerm = $(this).val().toLowerCase();
    var filteredOptions = countries_flags_and_codes.filter((option) =>
        option?.name?.toLowerCase().includes(searchTerm),
    );
    $('#dropdownContent').empty();

    if (filteredOptions.length < 1) {
        $('#dropdownContent').append(`<p class="dropdown-item is-size-7 text-align-left">
          <span class="icon mr-2">
            <i class="fas fa-exclamation-triangle"></i>
          </span>
          No results found
            </p>`);
    } else {
        filteredOptions.forEach((option) => {
            $('#dropdownContent').append(renderOption(option));
        });
    }
});

$('#dropdown-btn-trigger').on('click', function () {
    $('#searchableSelect').toggleClass('is-active');
});

$(document).on('click', '.dropdown-item', function () {
    var phoneCode = $(this).attr('class').split(' ')[0];

    selectedPhoneCode = countries_flags_and_codes.find((option) => option.phoneCode === phoneCode);

    $('#dropdown-btn-trigger').html(renderSelectedOption(selectedPhoneCode));

    // var currentPhoneNum = $('#phone_number').val();

    // if (currentPhoneNum.length > 0) {
    //   $('#phone_number').val(`+${selectedPhoneCode.phoneCode} ${currentPhoneNum}`);
    // } else {
    //   $('#phone_number').val(`+${selectedPhoneCode.phoneCode}`);
    // }

    $('#searchInput').val(`${selectedPhoneCode.name} (+${selectedPhoneCode.phoneCode})`);
    $('#searchableSelect').removeClass('is-active');
    $('#searchInput').removeClass('is-danger');
    $('#country_code_required_error').addClass('is-hidden');
});

$(document).click(function (event) {
    if (!$(event.target).closest('#searchableSelect').length) {
        $('#searchableSelect').removeClass('is-active');
    }
});

$('#project_description').val('');

/*************************************/
/* Searchable Select */
/* **********************************/

var banner_image_urls = [
    'https://thefreewebsiteguys.com/wp-content/uploads/2023/12/q1-banner.png',
    'https://thefreewebsiteguys.com/wp-content/uploads/2023/12/q2-banner.png ',
    'https://thefreewebsiteguys.com/wp-content/uploads/2023/12/q3-banner.png',
    'https://thefreewebsiteguys.com/wp-content/uploads/2023/12/q4-bbanner.png',
    'https://thefreewebsiteguys.com/wp-content/uploads/2023/12/q5-banner.png',
];

var mobile_background_image_class_names = ['q1-bg', 'q2-bg', 'q3-bg', 'q4-bg', 'q5-bg'];

function createSessionInstanceUUID() {
    var dt = new Date().getTime();
    var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        var r = (dt + Math.random() * 16) % 16 | 0;
        dt = Math.floor(dt / 16);
        return (c == 'x' ? r : (r & 0x3) | 0x8).toString(16);
    });
    return uuid;
}

var SUBMIT_FORM_URL = 'https://dev.eq.iworker-apps.me/v1/google-sheets/record-lead';
// var FORM_TRACKING_URL = 'http://localhost:8080/v1/google-sheets/record-potential-lead';
var FORM_TRACKING_URL = 'https://dev.eq.iworker-apps.me/v1/google-sheets/record-potential-lead';

$(document).ready(function () {
    //Get optional hidden fields from SUBMIT_FORM_URL  utm_source, utm_medium, utm_campaign, utm_term, utm_content
    var urlParams = new URLSearchParams(window.location.search);

    var sessionInstanceUUID = createSessionInstanceUUID();

    var utm_source = urlParams.get('utm_source') || '',
        utm_medium = urlParams.get('utm_medium') || '',
        utm_campaign = urlParams.get('utm_campaign') || '',
        utm_term = urlParams.get('utm_term') || '',
        utm_content = urlParams.get('utm_content') || '';

    var payload = {
        utm_source,
        utm_medium,
        utm_campaign,
        utm_term,
        utm_content,
        language: 'en',
        sessionInstanceUUID,
    };

    let hasSubmitted = false;

    function ajaxCall(url, method, data) {
        return $.ajax({
            url: url,
            method: method,
            data: data,
            dataType: 'json',
            contentType: 'application/json',
        });
    }

    var currentQuestion = 1;
    var totalQuestions = $('.question-container').length;

    function setModalImage() {
        function removeQuotes(str) {
            return str.replace(/['"]+/g, '');
        }

        var imageUrl = removeQuotes(banner_image_urls[currentQuestion - 1]);

        var modalImage = $('#modal-image');
        modalImage.empty();
        modalImage.append(
            `
            <img src="${imageUrl}" class="question-image-banner" width="100%" />
            `,
        );
    }

    function setMobileBackgroundImage() {
        function removeQuotes(str) {
            return str.replace(/['"]+/g, '');
        }

        var imageUrl = removeQuotes(mobile_background_image_class_names[currentQuestion - 1]);

        var questionContainerDiv = $('#question-container-wrapper');

        questionContainerDiv.removeClass(mobile_background_image_class_names.join(' '));

        questionContainerDiv.addClass(imageUrl);
    }

    setModalImage();
    setMobileBackgroundImage();

    function goToNextQuestion() {
        if (currentQuestion < totalQuestions) {
            if (currentQuestion == 1) {
                $('#prev-button_js').removeClass('is-hidden');
            }

            if (currentQuestion == 4) {
                $('#next-button_js').addClass('is-hidden');
            }

            $('#question-' + currentQuestion)
                .delay(500)
                .slideUp()
                .addClass('question-inactive');
            currentQuestion++;
            setModalImage();
            setMobileBackgroundImage();
            $('#question-' + currentQuestion)
                .delay(500)
                .slideDown()
                .removeClass('question-inactive');
        }
    }

    function goToPreviousQuestion() {
        if (currentQuestion > 1) {
            if (currentQuestion === 2) {
                $('#prev-button_js').addClass('is-hidden');
            }

            if (currentQuestion === 5) {
                $('#next-button_js').removeClass('is-hidden');
            }

            $('#question-' + currentQuestion)
                .delay(500)
                .slideUp()
                .addClass('question-inactive');

            currentQuestion--;
            setModalImage();
            setMobileBackgroundImage();
            $('#question-' + currentQuestion)
                .delay(500)
                .slideDown()
                .removeClass('question-inactive');
        }
    }

    $('#next-button_js').click(function () {
        var questionSubmitButtonIds = [
            '#project_description_submit',
            '#first_name_submit',
            '#email_address_submit',
            '#phone_number_submit',
        ];

        var currentQuestionSubmitButtonId = questionSubmitButtonIds[currentQuestion - 1];

        if (currentQuestionSubmitButtonId) {
            $(currentQuestionSubmitButtonId).click();
        }
    });

    $('#prev-button_js').click(function () {
        goToPreviousQuestion();
    });

    function validateEmail(email) {
        var re = /\S+@\S+\.\S+/;
        return re.test(email);
    }

    function requiredValidation(id) {
        var value = $(id).val();

        if (!value || value?.trim() == '' || value?.trim().length < 1) {
            $(id + '_required_error').removeClass('is-hidden');
            return false;
        }

        $(id + '_required_error').addClass('is-hidden');
        return true;
    }

    function emailValidation(id) {
        var value = $(id).val();

        if (!requiredValidation(id)) {
            return false;
        }

        if (!validateEmail(value)) {
            $(id + '_validation_error').removeClass('is-hidden');
            return false;
        }

        $(id + '_validation_error').addClass('is-hidden');
        return true;
    }

    function validatePhone(phone) {
        var phoneRe = /^(?:\+\d{1,3}\s?)?(\d{1,4}[-\s.]?)?\d{6,15}$/;
        let unformattedPhone = phone?.replace(/[\s\-\(\)]/g, '');
        var outcome = phoneRe.test(unformattedPhone);
        return outcome;
    }

    function phoneValidation(id) {
        var value = $(id).val();

        // phone number is optional
        if (!value || value?.trim() == '' || value?.trim().length < 1) {
            return true;
        }

        if (!validatePhone(value)) {
            $(id + '_validation_error').removeClass('is-hidden');
            return false;
        }

        $(id + '_validation_error').addClass('is-hidden');
        return true;
    }

    /*************************************/
    /* Project Description */
    /* **********************************/
    $('#project_description').on('input', function () {
        $(this).height('auto');
        $(this).height(this.scrollHeight - 10);
        requiredValidation('#project_description');
    });

    $('#project_description_submit').click(function () {
        if (!requiredValidation('#project_description')) {
            return;
        }

        payload.project_description = $('#project_description').val();
        goToNextQuestion();
    });

    /*************************************/
    /* First Name */
    /* **********************************/
    $('#first_name').on('input', function () {
        requiredValidation('#first_name');
    });

    $('#first_name_submit').click(function () {
        if (!requiredValidation('#first_name')) {
            return;
        }
        payload.first_name = $('#first_name').val();

        goToNextQuestion();
    });

    /*************************************/
    /* Email Address */
    /* **********************************/

    $('#email_address').on('input', function () {
        emailValidation('#email_address');
    });

    $('#email_address_submit').click(function () {
        if (!emailValidation('#email_address')) {
            return;
        }

        payload.email_address = $('#email_address').val();

        goToNextQuestion();
        $('#phone_number').focus();
    });

    /*************************************/
    /* Phone Number */
    /* **********************************/
    $('#phone_number').on('input', function () {
        phoneValidation('#phone_number');
        $('#searchInput').removeClass('is-danger');
        $('#country_code_required_error').addClass('is-hidden');
    });

    $('#phone_number_submit').click(function () {
        if (!phoneValidation('#phone_number')) {
            return;
        }
        payload.country_code = selectedPhoneCode;
        payload.phone_number = $('#phone_number').val();
        goToNextQuestion();
    });

    /*************************************/
    /* Web Hosting */
    /* **********************************/
    $('#no_web_hosting_submit').click(function () {
        // Perform validation or any other logic here
        var web_hosting = 'No';
        payload.web_hosting = web_hosting;

        // show icon for selected option and hide icon for other option
        $('#no_web_hosting_selected_icon').removeClass('is-hidden');

        if (!$('#has_web_hosting_selected_icon').hasClass('is-hidden')) {
            $('#has_web_hosting_selected_icon').addClass('is-hidden');
        }

        //show submit button
        $('#form_submit_container').removeClass('is-hidden');

        formTracking();
    });

    $('#has_web_hosting_submit').click(function () {
        // Perform validation or any other logic here
        var web_hosting = 'Yes';
        payload.web_hosting = web_hosting;

        // show icon for selected option and hide icon for other option
        $('#has_web_hosting_selected_icon').removeClass('is-hidden');

        if (!$('#no_web_hosting_selected_icon').hasClass('is-hidden')) {
            $('#no_web_hosting_selected_icon').addClass('is-hidden');
        }

        //show submit button
        $('#form_submit_container').removeClass('is-hidden');
        $('#form_submit_button');
        formTracking();
    });

    //if enter key is pressed on input field then click submit button for that question
    $('.input-box').keypress(function (e) {
        if (e.which == 13) {
            // if it is the first question  do nothing
            if (currentQuestion == 1) {
                return;
            }

            // find the submit button for this question
            var submitButton = $(this).closest('.question-container').find('.custom-button');

            //click the submit button
            submitButton.click();

            //focus on next input field
            $(this).closest('.question-container').next().find('.input-box').focus();
        }
    });

    //Form submit button
    $('#form_submit_button').click(function () {
        // Perform validation or any other logic here
        hasSubmitted = true;
        ajaxCall(
            `${SUBMIT_FORM_URL}`,
            'POST',
            JSON.stringify({
                ...payload,
                completed: true,
            }),
        )
            .then((res) => {
                window.location.href = `https://thefreewebsiteguys.com/thank-you/?etm=${btoa($('#email_address').val())}`;
            })
            .fail((err) => {
                return;
            });
    });

    // Optionally, if you have 'Previous' buttons
    $('.prev-button').click(function () {
        goToPreviousQuestion();
    });

    // Functions to open and close a modal
    function openModal($el) {
        //scroll  down 100px
        window.scrollBy(0, 100);

        $el.addClass('is-active');
        $('#question-container-wrapper').removeClass('is-hidden');
        $('#question-1').show();
    }

    function closeModal($el) {
        if (hasSubmitted) {
            $el.removeClass('is-active');
            return;
        }

        var project_description = $('#project_description').val() || '',
            first_name = $('#first_name').val() || '',
            email_address = $('#email_address').val() || '',
            phone_number = $('#phone_number').val() || '',
            web_hosting = payload.web_hosting || '';

        payload.project_description = project_description;
        payload.first_name = first_name;
        payload.email_address = email_address;
        payload.phone_number = phone_number;
        payload.web_hosting = web_hosting;
        payload.country_code = selectedPhoneCode;

        var completed = project_description && first_name && email_address && web_hosting;
        ajaxCall(
            `${SUBMIT_FORM_URL}`,
            'POST',
            JSON.stringify({
                ...payload,
                completed,
            }),
        )
            .then((res) => {
                hasSubmitted = true;
                var redirectUrl = 'https://thefreewebsiteguys.com/thank-you/';
            })
            .fail((err) => {
                return;
            });

        $el.removeClass('is-active');
        $('#question-container-wrapper').addClass('is-hidden');
    }

    function closeAllModals() {
        $('.modal').each(function () {
            closeModal($(this));
        });
    }

    // Add a click event on buttons to open a specific modal
    $('.js-modal-trigger').click(function () {
        var modal = $(this).data('target');
        var $target = $('#' + modal);

        openModal($target);
    });

    // Add a click event on various child elements to close the parent modal
    // $('.modal-background, .modal-close, .modal-card-head .delete, .modal-card-foot .button')
    $('.modal-close, .modal-card-head .delete, .modal-card-foot .button').click(function () {
        var $target = $(this).closest('.modal');

        closeModal($target);
    });

    // Add a keyboard event to close all modals
    $(document).keydown(function (event) {
        if (event.code === 'Escape') {
            closeAllModals();
        }
    });

    function formTracking() {
        var project_description = $('#project_description').val() || '',
            first_name = $('#first_name').val() || '',
            email_address = $('#email_address').val() || '',
            phone_number = $('#phone_number').val() || '',
            web_hosting = payload.web_hosting || '';

        payload.project_description = project_description;
        payload.first_name = first_name;
        payload.email_address = email_address;
        payload.phone_number = phone_number;
        payload.web_hosting = web_hosting;
        payload.country_code = selectedPhoneCode;

        var completed = project_description && first_name && email_address && web_hosting;

        //  get all possible browser metadata (user agent, browser, os, location, etc)

        const metadata = {
            userAgent: navigator.userAgent,
            browser: navigator.appName,
            browserVersion: navigator.appVersion,
            browserMajorVersion: navigator.appVersion,
            mobile: navigator.userAgent.match(/Android|BlackBerry|iPhone|iPad|iPod|Opera Mini|IEMobile/i)
                ? true
                : false,
            os: navigator.platform,
            osVersion: navigator.platform,
            cookiesEnabled: navigator.cookieEnabled,
            referrer: document.referrer,
            screenWidth: window.screen.width,
            screenHeight: window.screen.height,
            language: navigator.language,
            online: navigator.onLine,
            javaEnabled: navigator.javaEnabled(),
            completed,
        };

        ajaxCall(
            `${FORM_TRACKING_URL}`,
            'POST',
            JSON.stringify({
                lead: {
                    ...payload,
                    completed,
                },
                metadata,
            }),
        )
            .then((res) => {
                return;
            })
            .fail((err) => {
                return;
            });

        return null;
    }

    //send tracking data for all onblur events on the input fields
    $('.input-box').blur(function () {
        formTracking();
    });
});